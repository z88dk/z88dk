//-----------------------------------------------------------------------------
// Z80 assembler
// Copyright (C) Paulo Custodio, 2011-2025
// License: The Artistic License 2.0, http://www.perlfoundation.org/artistic_license_2_0
//-----------------------------------------------------------------------------

void Preprocessor::preprocess_file(const std::string& input_filename,
                                   const std::string& output_filename) {
    Preprocessor pp;

    if (!pp.open(input_filename)) {
        return;
    }

    std::ofstream ofs(output_filename, std::ios::out | std::ios::binary);
    if (!ofs) {
        g_errors.error(ErrorCode::FileOpenError, output_filename);
        return;
    }

    Location location;
    std::string line;
    while (pp.next_line(line)) {
        if (g_errors.filename() != location.filename()) {
            // filename changed (e.g. due to #include)
            location.set_filename(g_errors.filename());
            location.set_line_num(g_errors.line_num());
            ofs << "#line " << location.line_num() << ", \"" << location.filename() << "\""
                <<
                std::endl;
        }
        else if (g_errors.line_num() < location.line_num()) {
            // Line number decreased (e.g. due to #line directive)
            location.set_line_num(g_errors.line_num());
            ofs << "#line " << location.line_num() << std::endl;
        }
        else {
            // Normal line increment
            while (g_errors.line_num() > location.line_num()) {
                ofs << std::endl;
                location.inc_line_num();
            }
            location.set_line_num(g_errors.line_num());
        }
        ofs << line << std::endl;
        location.inc_line_num();
    }
}

void preprocess_only() {
    for (auto& input_file : g_input_files) {
        if (is_o_filename(input_file)) {
            if(g_options.verbose) {
                std::cout << "Skipping preprocessing for non-object file: " << input_file <<
                          std::endl;
            }
        }
        else {
            std::string output_file = get_i_filename(input_file);

            if (g_options.verbose) {
                std::cout << "Preprocessing file: " << input_file
                          << " -> " << output_file << std::endl;
            }

            Preprocessor pp;
            pp.preprocess_file(input_file, output_file);
        }
    }
}
