;------------------------------------------------------------------------------
; Z88DK Z80 Macro Assembler
;
; Z80/Z180/RCM2000/RCM3000 assembly table
; The order is important: an instruction is only loaded if not yet defined
;
; Copyright (C) Paulo Custodio, 2011-2017
; License: The Artistic License 2.0, http://www.perlfoundation.org/artistic_license_2_0
; Repository: https://github.com/z88dk/z88dk
;------------------------------------------------------------------------------

;------------------------------------------------------------------------------
; 8-bit load group
;------------------------------------------------------------------------------
		; ALTD ld {b|c|d|e|h|l||a}, {b|c|d|e|h|l|(hl)|a} \
												; => 40+$1*8+$2
		; ALTD ld {b|c|d|e|h|l||a}, N				=> 06+$1*8 N

			; ld	(hl), {b|c|d|e|h|l||a}			=> 70+$1
			; ld	(hl), N							=> 36 N

		; ALTD ld a, (NN) 						=> 3A NNl NNh
		; IO   ld a, (NN) 						=> 3A NNl NNh
			ld	(NN), a 						=> 32 NNl NNh

		ALTD ld a, {(bc)|(de)}					=> 0A+$1*10
			ld	{(bc)|(de)}, a					=> 02+$1*10

;------------------------------------------------------------------------------
; 8 bit arithmetic and logical group
;------------------------------------------------------------------------------
			{add|adc|sub|sbc|and|xor|or|cp} a, {b|c|d|e|h|l|(hl)|a}	\
												=> 80+$1*8+$2
			{add|adc|sub|sbc|and|xor|or|cp} a, N \
												=> C6+$1*8 N
		ALTD {inc|dec} {b|c|d|e|h|l|(hl)|a}		=> 04+$1+$2*8

[z180]		tst a, {b|c|d|e|h|l|(hl)|a}			=> ED 04+$1*8
[z180] 		tst a, N							=> ED 64 N

[zilog]		daa									=> 27
							
[zilog]		rrd									=> ED 67
[zilog]		rld									=> ED 6F

			cpl	a 								=> 2F
			neg a								=> ED 44
			ccf f								=> 3F
			scf f								=> 37

;------------------------------------------------------------------------------
; 16 bit load group
;------------------------------------------------------------------------------
		ALTD ld {bc|de|hl|sp}, NN				=> 01+$1*10 NNl NNh
		ALTD ld hl, (NN)						=> 2A NNl NNh
		ALTD ld {bc|de||sp}, (NN)				=> ED 4B+$1*10 NNl NNh

			ld	(NN), hl						=> 22 NNl NNh
			ld	(NN), {bc|de||sp}				=> ED 43+$1*10 NNl NNh

			ld	sp, hl							=> F9

			push {bc|de|hl|af}					=> C5+$1*10
[rabbit]	push ip								=> ED 76
[r3k]		push su								=> ED 66
				
		 ALTD pop {bc|de|hl|af}					=> C1+$1*10
[rabbit]	pop  ip								=> ED 7E
[r3k]		pop  su								=> ED 6E
				
[rabbit] ALTD ld hl, {ix|iy}						=> DD+$1*20 7C
[rabbit]	  ld {ix|iy}, hl						=> DD+$1*20 7D

[rabbit] ALTD ld hl, (hl+DIS)					=> DD E4 DIS
[rabbit] ALTD ld hl, (ix+DIS)					=>    E4 DIS
[rabbit] ALTD ld hl, (iy+DIS)					=> FD E4 DIS
			
[rabbit]	ld 	(hl+DIS), hl					=> DD F4 DIS
[rabbit]	ld 	(ix+DIS), hl					=>    F4 DIS
[rabbit]	ld 	(iy+DIS), hl					=> FD F4 DIS

[rabbit]	ld (sp+N), hl						=>    D4 N
[rabbit]	ld (sp+N), ix						=> DD D4 N
[rabbit]	ld (sp+N), iy						=> FD D4 N

[rabbit] ALTD ld hl, (sp+N)						=>    C4 N
[rabbit]	ld ix, (sp+N)						=> DD C4 N
[rabbit]	ld iy, (sp+N)						=> FD C4 N

[rabbit]	ld {bc|de|hl}', {de|bc}				=> ED 41+$1*10+$2*8

[rabbit]	ldp (NN), hl						=> ED 65 NNl NNh
[rabbit]	ldp (NN), ix						=> DD 65 NNl NNh
[rabbit]	ldp (NN), iy						=> FD 65 NNl NNh
			
[rabbit]	ldp hl, (NN)						=> ED 6D NNl NNh
[rabbit]	ldp ix, (NN)						=> DD 6D NNl NNh
[rabbit]	ldp iy, (NN)						=> FD 6D NNl NNh
			
[rabbit]	ldp (hl), hl						=> ED 64
[rabbit]	ldp (ix), hl						=> DD 64
[rabbit]	ldp (iy), hl						=> FD 64
			
[rabbit]	ldp hl, (hl)						=> ED 6C
[rabbit]	ldp hl, (ix)						=> DD 6C
[rabbit]	ldp hl, (iy)						=> FD 6C

;------------------------------------------------------------------------------
; Exchange group
;------------------------------------------------------------------------------
			ex af, {af|af'}						=> 08
			exx									=> D9
	
			ex (sp), hl							=> zilog ? E3 : ED 54
			ex (sp), ix							=> DD E3
			ex (sp), iy							=> FD E3

[rabbit] 	     ex (sp), hl'					=> 76 ED 54
[rabbit]	altd ex (sp), hl					=> 76 ED 54

	
				 ex de, hl						=>    EB
[rabbit]		 ex de', hl						=>    E3
[rabbit]		 ex de, hl'						=> 76 EB
[rabbit]		 ex de', hl'					=> 76 E3
				
[rabbit]	altd ex de, hl						=> 76 EB
[rabbit]	altd ex de', hl						=> 76 E3

;------------------------------------------------------------------------------
; 16 bit arithmetic and logical group
;------------------------------------------------------------------------------
		ALTD add hl, {bc|de|hl|sp}				=> 09+$1*10
		ALTD {sbc|adc} hl, {bc|de|hl|sp}		=> ED 42+$1*8+$2*10
	
		ALTD {inc|dec} {bc|de|hl|sp}			=> 03+$1*8+$2*10

[rabbit]	add sp, SN							=> 27 SN
[rabbit] ALTD {and|or} hl, de						=> DC+$1*10
[rabbit] ALTD bool hl							=> CC

[not_z80]	mlt {bc|de|hl|}						=> ED 4C+$1*10
[z180]		mlt {|||sp}							=> ED 4C+$1*10

; mul coded in parse_rules.rl as it has different opcodes for Rabbit and Z80-ZXN
; [rabbit]	mul									=> F7
	
[r3k]		uma									=> ED C0
[r3k]		ums									=> ED C8

;------------------------------------------------------------------------------
; 8 Bit Rotate and Shift Group
;------------------------------------------------------------------------------
			{rlca|rrca|rla|rra}					=> 07+$1*8
	
			{rlc|rrc|rl|rr|sla|sra|         |srl} {b|c|d|e|h|l|(hl)|a} \
												=> CB $1*8+$2
[zilog]		{   |   |  |  |   |   |{sll|sli}|   } {b|c|d|e|h|l|(hl)|a} \
												=> CB $1*8+$3


[z80]		{rlc|rrc|rl|rr|sla|sra|{sll|sli}|srl} ({ix|iy}+DIS), {b|c|d|e|h|l||a} \
												=> DD+$3*20 CB DIS $1*8+$4

;------------------------------------------------------------------------------
; Bit Set, Reset, and Test Group
;------------------------------------------------------------------------------
			{|bit|ALTD res|ALTD set} CONST, {b|c|d|e|h|l|(hl)|a} \
												=> CB $1*40+choose(0:0 1:1 2:2 3:3 \
																   4:4 5:5 6:6 7:7)*8+$2

;------------------------------------------------------------------------------
; 16 Bit Rotate and Shift Group
;------------------------------------------------------------------------------
[rabbit] ALTD rl de								=> F3
[rabbit] ALTD rr de								=> FB
[rabbit] ALTD rr hl								=> FC

;------------------------------------------------------------------------------
; CPU control group
;------------------------------------------------------------------------------
			nop									=>    00

[zilog]		halt								=>    76
[z180]		slp									=> ED 76
				
[r3k]		rdmode								=> ED 7F
[r3k]		setusr								=> ED 6F
[r3k]		sures								=> ED 7D
[r3k]		syscall								=> ED 75

;------------------------------------------------------------------------------
; Interrupt control group
;------------------------------------------------------------------------------
[zilog]		di									=> F3
[zilog]		ei									=> FB
				
[zilog]		im	CONST							=> ED choose(0:46 1:56 2:5E)

[zilog]		ld	i, a							=> ED 47
[zilog]		ld	a, i							=> ED 57
			
[zilog]		ld	r, a							=> ED 4F
[zilog]		ld	a, r							=> ED 5F

[rabbit] 	  ld eir, a							=> ED 47
[rabbit] ALTD ld a, eir							=> ED 57
				
[rabbit]      ld iir, a							=> ED 4F
[rabbit] ALTD ld a, iir							=> ED 5F
				
[rabbit]	ipset CONST							=> ED choose(0:46 1:56 2:4E 3:5E)
[rabbit]	ipres								=> ED 5D

			reti								=> ED 4D

[zilog]		retn								=> ED 45
[r3k]		idet								=> 5B

;------------------------------------------------------------------------------
; Jump Group
;------------------------------------------------------------------------------
			jp 	NN								=> C3 NNl NNh
			jp 	{nz|z|nc|c|{po|nv}|{pe|v}|p|m}, NN \
												=> C2+$1*8 NNl NNh
[rabbit] 	jp	{||||lz|lo||}, NN 				=> C2+$1*8 NNl NNh

			jp 	(hl)							=> E9

			jr 	NN								=> 18 NNe
			jr 	{nz|z|nc|c}, NN					=> 20+$1*8 NNe

			djnz NN								=> 10 NNe
			djnz b, NN							=> 10 NNe

; TODO: check that address is corretly computed in DJNZ B', LABEL - 76 10 FE or 76 10 FD
[rabbit]	altd djnz NN						=> 76 10 NNe
[rabbit]	djnz b', NN							=> 76 10 NNe

[rabbit]      ld xpc, a							=> ED 67
[rabbit] ALTD ld a, xpc							=> ED 77

; TODO: LJP not supported

;------------------------------------------------------------------------------
; Call and Return Group
;------------------------------------------------------------------------------
			call NN								=> CD NNl NNh
			call {nz|z|nc|c|{po|nv}|{pe|v}|p|m}, NN	\
												=> C4+$1*8 NNl NNh
[rabbit] 	call {||||lz|lo||}, NN				=> C4+$1*8 NNl NNh

; TODO: LCALL not supported

			rst CONST							=> choose(       16:D7 24:DF 32:E7 40:EF 56:FF)
[zilog]		rst CONST							=> choose(0:C7 8:CF                   48:F7   )

			ret									=> C9
			ret {nz|z|nc|c|{po|nv}|{pe|v}|p|m}	=> C0+$1*8
[rabbit] 	ret {||||lz|lo||}					=> C0+$1*8

; TODO: LRET not supported

;------------------------------------------------------------------------------
; Block Transfer Group
;------------------------------------------------------------------------------
		IO	ldi 								=> ED A0
		IO	ldir								=> ED B0
		IO	ldd 								=> ED A8
		IO	lddr								=> ED B8

[r3k]		ldisr								=> ED 90
[r3k]		lddsr								=> ED 98
				
[r3k]		lsdr								=> ED F8
[r3k]		lsir								=> ED F0
[r3k]		lsddr								=> ED D8
[r3k]		lsidr								=> ED D0

;------------------------------------------------------------------------------
; Search Group
;------------------------------------------------------------------------------
[zilog]		cpi 								=> ED A1
[zilog]		cpir								=> ED B1
[zilog]		cpd 								=> ED A9
[zilog]		cpdr								=> ED B9

;------------------------------------------------------------------------------
; Input and Output Group
;------------------------------------------------------------------------------
[zilog]		in  a, (N)							=> DB N
[zilog]		in  {b|c|d|e|h|l|f|a}, (c)			=> ED 40+$1*8
[z180]		in0 {b|c|d|e|h|l|f|a}, (N)			=> ED 00+$1*8 N
		
[zilog]		out  (N), a							=> D3 N
[zilog]		out  (c), {b|c|d|e|h|l||a}			=> ED 41+$1*8
[zilog]		out  (c), CONST						=> ED 41+choose(0:6)*8
		
[z180]		out0 (N), {b|c|d|e|h|l||a}			=> ED 01+$1*8 N
		
[z180]		tstio N								=> ED 74 N

[zilog]		ini									=> ED A2
[zilog]		inir								=> ED B2
[zilog]		ind									=> ED AA
[zilog]		indr								=> ED BA

[zilog]		outi								=> ED A3
[zilog]		otir								=> ED B3
[zilog]		outd								=> ED AB
[zilog]		otdr								=> ED BB
					
[z180]		otdm								=> ED 8B
[z180]		otdmr								=> ED 9B
[z180]		otim								=> ED 83
[z180]		otimr								=> ED 93

__END__

;------------------------------------------------------------------------------
;------------------------------------------------------------------------------
;------------------------------------------------------------------------------
;------------------------------------------------------------------------------
;------------------------------------------------------------------------------
;------------------------------------------------------------------------------
;------------------------------------------------------------------------------
;------------------------------------------------------------------------------
;------------------------------------------------------------------------------
;------------------------------------------------------------------------------
;------------------------------------------------------------------------------
;------------------------------------------------------------------------------
;------------------------------------------------------------------------------
;------------------------------------------------------------------------------
;------------------------------------------------------------------------------



;------------------------------------------------------------------------------
; 16 bit load group - composed opcodes
;------------------------------------------------------------------------------



; 16-bits load group

ld	{bc||de||hl}, {bc||de||hl}	=> 40+$1*8+$2      49+$1*8+$2
ld	{bc||de||}, ix				=> DD 44+$1*8     DD 4D+$1*8
ld	{bc||de||}, iy				=> FD 44+$1*8     FD 4D+$1*8

ld	{bc||de||}, (hl)				=> 4E+$1*8 23     46+$1*8 2B
ldi	{bc||de||}, (hl)				=> 4E+$1*8 23     46+$1*8 23

ld	{bc||de||hl}, (ix+DIS)		=> DD 4E+$1*8 DIS           DD 46+$1*8 DIS+1
ldi	{bc||de||hl}, (ix+DIS)		=> DD 4E+$1*8 DIS DD 23 DD 46+$1*8 DIS DD 23 

ld	{bc||de||hl}, (iy+DIS)		=> FD 4E+$1*8 DIS           FD 46+$1*8 DIS+1
ldi	{bc||de||hl}, (iy+DIS)		=> FD 4E+$1*8 DIS FD 23 FD 46+$1*8 DIS FD 23

ld 	(hl), {bc||de}				=> 71+$2 23     70+$2 2B
ldi	(hl), {bc||de}				=> 71+$2 23     70+$2 23

ld 	(ix+DIS), {bc||de||hl}		=> DD 71+$2 DIS           DD 70+$2 DIS+1
ldi	(ix+DIS), {bc||de||hl}		=> DD 71+$2 DIS DD 23 DD 70+$2 DIS DD 23

ld 	(iy+DIS), {bc||de||hl}		=> FD 71+$2 DIS FD 70+$2 DIS+1
ldi	(iy+DIS), {bc||de||hl}		=> FD 71+$2 DIS FD 23 FD 70+$2 DIS FD 23

ld 	hl, ix						=> DD E5 E1
ld 	hl, iy						=> FD E5 E1

ld	ix, {bc||de||}				=> DD 69+$2       DD 60+$2
ld	iy, {bc||de||}				=> FD 69+$2       FD 60+$2

ld ix, hl						=> E5 DD E1
ld iy, hl						=> E5 FD E1

ld ix, ix						=> DD 6D DD 64
ld ix, iy						=> FD E5 DD E1

ld iy, iy						=> FD 6D FD 64
ld iy, ix						=> DD E5 FD E1

;------------------------------------------------------------------------------
; 16 bit load group





;------------------------------------------------------------------------------
; Exchange, block transfer, search group

ex	de, hl										=> EB
ex	af, af'										=>		08	# '
exx												=> 		D9

ex	(sp), hl										=>		E3
ex	(sp), ix										=> DD E3
ex	(sp), iy										=> FD E3

ldi												=> ED A0
ldir											=> ED B0
ldd												=> ED A8
lddr											=> ED B8

cpi												=> ED A1
cpir											=> ED B1
cpd												=> ED A9
cpdr											=> ED B9

;------------------------------------------------------------------------------
; 8 bit arithmetic and logical group

add hl, {bc|de|hl|sp}							=>		09+$2*10
add ix, {bc|de|ix|sp}							=> DD 09+$2*10
add iy, {bc|de|iy|sp}							=> FD 09+$2*10

{sbc|adc} hl, {bc|de|hl|sp}						=> ED 42+{0:3}+$2*10
sub hl, {bc|de|hl|sp}							=> B7 ED 42+$2*10

{inc|dec} {bc|de|hl|sp}							=>		03+{0:3}+$1*10
{inc|dec} {||ix|}								=> DD 03+{0:3}+$1*10
{inc|dec} {||iy|}								=> FD 03+{0:3}+$1*10

;------------------------------------------------------------------------------
; rotate and shift group

; rotate 16 bits

rl {bc||de||hl}					=> CB 11+$1 CB 10+$1
rr {bc||de||hl}					=> CB 18+$1 CB 19+$1

sla hl							=> 29			# special case: add hl, hl
sla {bc||de||hl}				=> CB 21+$1 CB 10+$1
sll {bc||de||hl}				=> CB 31+$1 CB 10+$1
sli {bc||de||hl}				=> CB 31+$1 CB 10+$1

sra {bc||de||hl}				=> CB 28+$1 CB 19+$1
srl {bc||de||hl}				=> CB 38+$1 CB 19+$1

;------------------------------------------------------------------------------
; Bit Set, Reset and Test Group

{|bit|res|set} {0|1|2|3|4|5|6|7}, {b|c|d|e|h|l||a}			=> CB     {0:6}+$1*8+$2
{|bit|res|set} {0|1|2|3|4|5|6|7}, (hl)						=> CB     {0:6}+$1*8+6
{|bit|res|set} {0|1|2|3|4|5|6|7}, (ix+DIS)					=> DD CB DIS {0:6}+$1*8+6
{|bit|res|set} {0|1|2|3|4|5|6|7}, (iy+DIS)					=> FD CB DIS {0:6}+$1*8+6
{||res|set}    {0|1|2|3|4|5|6|7}, (ix+DIS), {b|c|d|e|h|l||a}	=> DD CB DIS {0:6}+$1*8+$3
{||res|set}    {0|1|2|3|4|5|6|7}, (iy+DIS), {b|c|d|e|h|l||a}	=> FD CB DIS {0:6}+$1*8+$3

;------------------------------------------------------------------------------
; Jump Group

			jp NN											=> 		C3       NNl NNh
			jp {nz|z|nc|c|{po|nv}|{pe|v}|p|m}, NN						=> 		C2+$1*8 NNl NNh

			jr NN											=> 		18       NNo
			jr {nz|z|nc|c}, NN								=> 		20+$1*8 NNo
			jr {||||{po|nv}|{pe|v}|p|m}, NN							=> 		C2+$1*8 NNl NNh
			djnz NN											=>		10       NNo

			jp (hl)											=> 		E9
			jp (ix)											=> DD	E9
			jp (iy)											=> FD	E9

;------------------------------------------------------------------------------
; Call and Return Group

call NN											=> 		CD       NNl NNh
call {nz|z|nc|c|{po|nv}|{pe|v}|p|m}, NN					=> 		C4+$1*8 NNl NNh
ret												=> 		C9
ret {nz|z|nc|c|{po|nv}|{pe|v}|p|m}						=> 		C0+$1*8
reti											=> ED 4D
retn											=> ED 45
rst {0|8|16|24|32|40|48|56}						=> 		C7+($1*8&0b00111000)
rst {0|1|2|3|4|5|6|7}							=> 		C7+($1*8&0b00111000)

;------------------------------------------------------------------------------
; Input and Output Group

in a, (N)										=>		DB N
in {b|c|d|e|h|l||a}, (c)							=> ED 40+$1*8
in f, (c)										=> ED 70

ini												=> ED A2
inir											=> ED B2
ind												=> ED AA
indr											=> ED BA

out (N), a										=>		D3 N
out (c), {b|c|d|e|h|l||a}						=> ED 41+$2*8
out (c), 0										=> ED 71

outi											=> ED A3
otir											=> ED B3
outd											=> ED AB
otdr											=> ED BB

;------------------------------------------------------------------------------
; Special instruction for CPU::Emulator::Z80

stop											=> DD DD 00
